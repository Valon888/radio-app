<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini IPTV + Radio</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="stylesheet" href="styles.css">
<script>
// Create an empty favicon to stop 404 errors
document.addEventListener('DOMContentLoaded', function() {
  const canvas = document.createElement('canvas');
  canvas.width = 16;
  canvas.height = 16;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#0078d7'; // Blue color
  ctx.fillRect(0, 0, 16, 16);

  // Convert to blob and create URL
  canvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link');
      link.rel = 'icon';
      link.href = url;
      document.head.appendChild(link);
  });
});
</script>
<!-- Load scripts in proper order to avoid variable redeclaration issues -->
<script src="fallback-channels.js"></script>
<script src="radio-channels.js"></script>
<script src="radio-app.js"></script>
<script src="turkish-channels.js"></script>
<script src="german-channels.js"></script>
<script src="imported-channels.js"></script>
<script src="playlist-loader.js"></script>
<script src="items.js"></script>
<script src="test-streams.js"></script>
</head>
<body>
<header>
  <img src="file_0000000061906246a7cec4605005f737.png" alt="App Logo" class="app-logo" />
  <span class="app-title accent-blue">Mini IPTV + Radio</span>
  <input id="search" type="search" placeholder="Kërko kanal…" aria-label="Kërko kanal" />
  <select id="filterType" aria-label="Filtri llojit">
    <option value="">Të gjitha</option>
    <option value="tv">TV</option>
    <option value="radio">Radio</option>
    <option value="external">Linqe të jashtme</option>
    <option value="iframe">Iframe</option>
  </select>
  <select id="filterGroup" aria-label="Filtri grupit">
    <option value="">Të gjitha grupet</option>
    <option value="Shqipëri">Shqipëri</option>
    <option value="Kosovë">Kosovë</option>
    <option value="Türkiye">Turqi</option>
    <option value="German">Gjermane</option>
    <option value="German - Public TV">Gjermane - TV Publike</option>
    <option value="German - News">Gjermane - Lajme</option>
    <option value="German - Movies">Gjermane - Filma</option>
    <option value="German - Music">Gjermane - Muzikë</option>
    <option value="German - Kids">Gjermane - Fëmijë</option>
    <option value="German - Sports">Gjermane - Sport</option>
  </select>
  <div class="header-buttons">
    <button id="showAllBtn" class="control-button" title="Shfaq të gjitha kanalet">Shfaq Të Gjitha</button>
    <button id="reloadChannelsBtn" class="control-button" title="Ringarko të gjitha kanalet">Ringarko</button>
  </div>
</header>
<div class="wrap">
  <main>
    <div class="meta">
      <span id="title" class="title"></span>
      <span id="epg" class="epg"></span>
    </div>
    <div class="player">
      <img id="chanLogo" class="chan-logo" alt="Logo" />
      <video id="video" controls autoplay class="main-player"></video>
      <div class="resolution-row">
        <label for="resolutionSel" class="resolution-label">Rezolucioni:</label>
        <select id="resolutionSel" class="resolution-select">
          <option value="1080p">1080p</option>
          <option value="720p">720p</option>
          <option value="480p">480p</option>
          <option value="2160p">2160p</option>
        </select>
      </div>
      <audio id="audio" controls></audio>
      <div class="player-controls">
        <button id="playPauseBtn" class="control-button">Play/Pause</button>
        <button id="muteBtn" class="control-button">Mute</button>
        <button id="fullscreenBtn" class="control-button">Fullscreen</button>
      </div>
    </div>
    <div id="status" class="muted"></div>
  </main>
  <aside id="list" aria-label="Lista e kanaleve"></aside>
</div>
<footer>
  <span>© 2025 Mini IPTV + Radio | <a href="https://radiostargjilan.com/web/" target="_blank" rel="noopener" class="accent-blue">Radio Star Gjilan</a></span>
</footer>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
<script>
// Deklarim global i variablave
window._channelsList = []; // Private backing array for channels

// Përdor window.items nga items.js
console.log('[Mini IPTV] Initial window.items:', window.items);

// Update channels reference when items are updated
Object.defineProperty(window, 'items', {
  get: function() { return this._items || []; },
  set: function(newItems) { 
    console.log('[Mini IPTV] window.items updated:', newItems ? newItems.length : 0);
    this._items = newItems;
    
    // Update channelsList
    window._channelsList.length = 0;
    if (Array.isArray(newItems)) {
      newItems.forEach(item => window._channelsList.push(item));
    }
    
    // Update dropdown groups if available
    this.channelsLoaded = true;
    if (typeof updateFilterGroups === 'function') {
      updateFilterGroups();
    }
  }
});

// Video player initializations
const video = document.getElementById('video');
const audio = document.getElementById('audio');
const chanLogo = document.getElementById('chanLogo');
let hls = null;

// Filter UI elements
const search = document.getElementById('search');
const filterType = document.getElementById('filterType');
const filterGroup = document.getElementById('filterGroup');
const list = document.getElementById('list');
const title = document.getElementById('title');
const epg = document.getElementById('epg');
const playPauseBtn = document.getElementById('playPauseBtn');
const muteBtn = document.getElementById('muteBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const resolutionSel = document.getElementById('resolutionSel');
const statusEl = document.getElementById('status');

// Ngarko të gjitha grupet e disponueshme për filtrim
function updateFilterGroups() {
  if (!Array.isArray(window.items) || window.items.length === 0) {
    console.warn('[Mini IPTV] Nuk ka kanale të disponueshme për të populluar grupet');
    return;
  }
  
  // Mbaj opsionin aktual
  const currentGroup = filterGroup.value;
  
  // Reset dropdown groups
  filterGroup.innerHTML = '<option value="">Të gjitha grupet</option>';
  
  // Merr të gjitha grupet unike
  const uniqueGroups = [...new Set(window.items
    .filter(item => item && item.group)
    .map(item => item.group)
    .filter(Boolean)
  )];
  
  // Shto grupet në dropdown sipas rëndësisë
  const priorityOrder = {
    'Kosovë': 1,
    'Shqipëri': 2,
    'Fëmijë Shqip': 3,
    'Türkiye': 4,
    'Fetare Islame': 5
  };
  
  // Rendit grupet sipas prioritetit
  uniqueGroups.sort((a, b) => {
    const priorityA = priorityOrder[a] || 99;
    const priorityB = priorityOrder[b] || 99;
    
    if (priorityA !== priorityB) {
      return priorityA - priorityB;
    }
    
    return a.localeCompare(b);
  });
  
  // Krijo dhe shto opsionet në dropdown
  uniqueGroups.forEach(group => {
    const option = document.createElement('option');
    option.value = group;
    option.textContent = group;
    filterGroup.appendChild(option);
  });
  
  // Rikthe vlerën e zgjedhur nëse është ende e vlefshme
  if (uniqueGroups.includes(currentGroup)) {
    filterGroup.value = currentGroup;
  }
  
  console.log(`[Mini IPTV] Grupet u përditësuan: ${uniqueGroups.length} grupe`);
}

// Filtro dhe shfaq të gjitha kanalet
function updateUIWithChannels(forceFetch = false) {
  // Në rastin e përdorimit fillestar, kontrollo nëse ka nevojë të ngarkohen kanalet
  if (!window.channelsLoaded || forceFetch) {
    console.log('[Mini IPTV] Duke ngarkuar të gjitha kanalet...');
    
    // Provo të ngarkosh nga playlist-loader
    if (window.playlistLoader && typeof window.playlistLoader.loadAllPlaylists === 'function') {
      statusEl.innerHTML = '<div class="loading-spinner"></div> Duke ngarkuar të gjitha kanalet...';
      
      window.playlistLoader.loadAllPlaylists()
        .then(channels => {
          if (Array.isArray(channels) && channels.length > 0) {
            window.items = channels;
            console.log(`[Mini IPTV] Ngarkuar ${channels.length} kanale nga playlist-loader`);
            
            // Thirrje rekursive për përditësimin e UI
            updateUIWithChannels();
          } else {
            console.warn('[Mini IPTV] Nuk u gjetën kanale nga playlist-loader');
            statusEl.innerHTML = '<div class="warning-icon">⚠️</div> Nuk u gjetën kanale nga playlist-loader';
          }
        })
        .catch(error => {
          console.error('[Mini IPTV] Gabim në ngarkimin e kanaleve:', error);
          statusEl.innerHTML = `<div class="error-icon">⚠️</div> Gabim në ngarkimin e kanaleve: ${error.message || 'Gabim i panjohur'}`;
        });
      
      return;
    }
  }
  
  // Krijo një kopje të array për filtrim
  let filtered = window.items ? [...window.items] : [];
  
  // Filtro sipas llojit
  const typeFilter = filterType.value;
  if (typeFilter) {
    filtered = filtered.filter(item => item.type === typeFilter);
  }
  
  // Filtro sipas grupit
  const groupFilter = filterGroup.value;
  if (groupFilter) {
    filtered = filtered.filter(item => item.group === groupFilter);
  }
  
  // Filtro sipas tekstit të kërkimit
  const searchText = search.value.toLowerCase();
  if (searchText) {
    filtered = filtered.filter(item => {
      // Kërko në emër, grup dhe url
      return (
        (item.name && item.name.toLowerCase().includes(searchText)) ||
        (item.group && item.group.toLowerCase().includes(searchText)) ||
        (item.url && item.url.toLowerCase().includes(searchText))
      );
    });
  }
  
  // Shfaq rezultatet në UI
  displayChannels(filtered);
}

// Shfaq kanalet në UI
function displayChannels(channels) {
  if (!Array.isArray(channels)) {
    console.error('[Mini IPTV] displayChannels: channels is not an array', channels);
    return;
  }
  
  // Reset HTML
  list.innerHTML = '';
  
  // Shto titull të kategorisë aktuale
  const groupName = filterGroup.value || 'Të gjitha';
  const typeFilter = filterType.value ? ` (${filterType.value})` : '';
  
  const header = document.createElement('h2');
  header.className = 'category-header';
  header.textContent = `${groupName}${typeFilter}`;
  list.appendChild(header);
  
  // Grup aktual për kategorizim
  let currentGroup = null;
  let groupContainer = null;
  
  // Listo të gjitha kanalet e filtruara
  channels.forEach(channel => {
    // Kontrollo për vlera të pavlefshme
    if (!channel || !channel.name || !channel.url) return;
    
    // Krijo struktura grupimi nëse është kërkuar
    if (channel.group && !filterGroup.value && channel.group !== currentGroup) {
      currentGroup = channel.group;
      
      const groupDiv = document.createElement('div');
      groupDiv.className = 'channel-group';
      
      const groupHeader = document.createElement('h3');
      groupHeader.className = 'group-header';
      groupHeader.textContent = currentGroup;
      
      groupContainer = document.createElement('div');
      groupContainer.className = 'group-channels';
      
      groupDiv.appendChild(groupHeader);
      groupDiv.appendChild(groupContainer);
      list.appendChild(groupDiv);
    }
    
    // Krijo elementin e kanalit
    const item = document.createElement('div');
    item.className = 'item';
    item.setAttribute('data-id', channel.id || '');
    item.setAttribute('data-url', channel.url);
    item.setAttribute('data-type', channel.type || 'tv');
    
    // Shto ikona për cilësinë
    let qualityIcon = '';
    if (channel.quality) {
      if (channel.quality.includes('1080')) {
        qualityIcon = '<span class="quality-badge high">1080p</span>';
      } else if (channel.quality.includes('720')) {
        qualityIcon = '<span class="quality-badge medium">720p</span>';
      } else if (channel.quality.includes('480') || channel.quality.includes('360')) {
        qualityIcon = '<span class="quality-badge low">SD</span>';
      }
    }
    
    // Shto logo nëse ka
    let logoHtml = '';
    if (channel.logo) {
      logoHtml = `<img src="${channel.logo}" alt="Logo" class="channel-logo" onerror="this.style.display='none';" />`;
    }
    
    // Shto përmbajtjen e kanalit
    item.innerHTML = `
      <div class="channel-info">
        ${logoHtml}
        <span class="channel-name">${channel.name}</span>
        ${qualityIcon}
      </div>
    `;
    
    // Lidh ngjarjen e klikimit
    item.addEventListener('click', (e) => {
      e.preventDefault();
      playChannel(channel);
    });
    
    // Shto në containerin e duhur
    if (groupContainer && !filterGroup.value) {
      groupContainer.appendChild(item);
    } else {
      list.appendChild(item);
    }
  });
  
  // Përditëso statusin
  const tvCount = channels.filter(item => item.type === 'tv' || !item.type).length;
  const radioCount = channels.filter(item => item.type === 'radio').length;
  
  if (statusEl) {
    if (channels.length === 0) {
      statusEl.innerHTML = '<div class="warning-icon">⚠️</div> Nuk u gjetën kanale që përputhen me filtrin';
    } else {
      statusEl.innerHTML = `<div class="success-icon">✓</div> Duke shfaqur ${channels.length} kanale (${tvCount} TV, ${radioCount} radio)`;
    }
  }
}

// Play a channel
function playChannel(channel) {
  if (!channel || !channel.url) {
    console.error('[Mini IPTV] Kanali i pavlefshëm ose URL mungon', channel);
    return;
  }
  
  // Update UI with channel info
  title.textContent = channel.name || '';
  epg.textContent = channel.group || '';
  
  // Set channel logo if available
  if (channel.logo) {
    chanLogo.src = channel.logo;
    chanLogo.style.display = 'block';
  } else {
    chanLogo.style.display = 'none';
  }
  
  // Choose player type based on channel type
  if (channel.type === 'radio') {
    // Audio player for radio
    video.style.display = 'none';
    audio.style.display = 'block';
    
    // Stop HLS if active
    if (hls) {
      hls.destroy();
      hls = null;
    }
    
    audio.src = channel.url;
    audio.play().catch(e => {
      console.error('[Mini IPTV] Gabim në luajtjen e audio:', e);
      statusEl.innerHTML = `<div class="error-icon">⚠️</div> Gabim në luajtjen e audio: ${e.message}`;
    });
  } else {
    // Video player for TV
    video.style.display = 'block';
    audio.style.display = 'none';
    
    // Stop audio if playing
    audio.pause();
    audio.src = '';
    
    // Check if the URL is HLS
    if (channel.url.match(/\.m3u8(\?|$)/i)) {
      if (Hls.isSupported()) {
        // Stop previous HLS instance if exists
        if (hls) {
          hls.destroy();
        }
        
        // Create new HLS instance
        hls = new Hls({
          enableWorker: true,
          lowLatencyMode: true,
          backBufferLength: 90
        });
        
        hls.loadSource(channel.url);
        hls.attachMedia(video);
        
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          video.play().catch(e => {
            console.error('[Mini IPTV] Gabim në luajtjen e videos:', e);
            statusEl.innerHTML = `<div class="error-icon">⚠️</div> Gabim në luajtjen e videos: ${e.message}`;
          });
        });
        
        hls.on(Hls.Events.ERROR, function(event, data) {
          if (data.fatal) {
            console.error('[Mini IPTV] HLS error:', data);
            statusEl.innerHTML = `<div class="error-icon">⚠️</div> Gabim në HLS: ${data.details || 'Gabim i panjohur'}`;
            
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                // try to recover network error
                console.log('[Mini IPTV] Duke tentuar të korrigjoj gabimin e rrjetit...');
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                console.log('[Mini IPTV] Duke tentuar të korrigjoj gabimin e medias...');
                hls.recoverMediaError();
                break;
              default:
                // cannot recover
                hls.destroy();
                break;
            }
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // For native HLS support (Safari)
        video.src = channel.url;
        video.addEventListener('canplay', function() {
          video.play();
        });
      }
    } else {
      // For regular video URLs
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      video.src = channel.url;
      video.play().catch(e => {
        console.error('[Mini IPTV] Gabim në luajtjen e videos:', e);
        statusEl.innerHTML = `<div class="error-icon">⚠️</div> Gabim në luajtjen e videos: ${e.message}`;
      });
    }
  }
  
  // Mark current channel as active
  document.querySelectorAll('.item').forEach(item => item.classList.remove('active'));
  document.querySelector(`.item[data-url="${channel.url}"]`)?.classList.add('active');
}

// Event listeners for player controls
playPauseBtn.addEventListener('click', () => {
  const player = video.style.display !== 'none' ? video : audio;
  if (player.paused) {
    player.play();
  } else {
    player.pause();
  }
});

muteBtn.addEventListener('click', () => {
  const player = video.style.display !== 'none' ? video : audio;
  player.muted = !player.muted;
  muteBtn.textContent = player.muted ? 'Unmute' : 'Mute';
});

fullscreenBtn.addEventListener('click', () => {
  if (video.requestFullscreen) {
    video.requestFullscreen();
  } else if (video.webkitRequestFullscreen) { /* Safari */
    video.webkitRequestFullscreen();
  } else if (video.msRequestFullscreen) { /* IE11 */
    video.msRequestFullscreen();
  }
});

// Event listeners for filters
search.addEventListener('input', updateUIWithChannels);
filterType.addEventListener('change', updateUIWithChannels);
filterGroup.addEventListener('change', updateUIWithChannels);

// Butoni për shfaqjen e të gjitha kanaleve
const showAllBtn = document.getElementById('showAllBtn');
if (showAllBtn) {
  showAllBtn.addEventListener('click', () => {
    // Reset të gjitha filtrat
    search.value = '';
    filterType.value = '';
    filterGroup.value = '';
    
    // Përditëso UI
    updateUIWithChannels();
    
    // Shfaq mesazhin e statusit
    const tvCount = window.items.filter(item => item.type === 'tv' || !item.type).length;
    const radioCount = window.items.filter(item => item.type === 'radio').length;
    statusEl.innerHTML = `<div class="success-icon">✓</div> Duke shfaqur të gjitha ${window.items.length} kanalet (${tvCount} TV, ${radioCount} radio)`;
  });
}

// Butoni për ringarkimin e kanaleve
const reloadChannelsBtn = document.getElementById('reloadChannelsBtn');
if (reloadChannelsBtn) {
  reloadChannelsBtn.addEventListener('click', async () => {
    const statusEl = document.getElementById('status');
    
    // Shfaq mesazh ngarkimi
    if (statusEl) {
      statusEl.innerHTML = '<div class="loading-spinner"></div> Duke ringarkuar të gjitha kanalet...';
    }
    
    console.log('[Mini IPTV] Duke ringarkuar kanalet...');
    
    try {
      // Pastro cache-in e playlist-ëve
      if (window.playlistLoader) {
        // Invalidate the cache
        window.playlistLoader.clearCache = true;
        
        // Ringarko të gjitha kanalet
        const allChannels = await window.playlistLoader.loadAllPlaylists();
        
        console.log(`[Mini IPTV] Ngarkuar ${allChannels.length} kanale nga playlist-loader`);
        
        // Përditëso variablat globale
        window.items = allChannels;
        
        // Përditëso UI
        updateUIWithChannels();
        
        if (statusEl) {
          const tvCount = window.items.filter(item => item.type === 'tv' || !item.type).length;
          const radioCount = window.items.filter(item => item.type === 'radio').length;
          statusEl.innerHTML = `<div class="success-icon">✓</div> Ringarkuar me sukses ${allChannels.length} kanale (${tvCount} TV, ${radioCount} radio)`;
        }
      } else {
        // Nëse nuk ka playlist-loader, ringarkojmë faqen
        if (statusEl) {
          statusEl.textContent = 'Playlist-loader nuk u gjet. Duke rinisur aplikacionin...';
        }
        setTimeout(() => window.location.reload(), 1000);
      }
    } catch (error) {
      console.error('[Mini IPTV] Gabim në ringarkimin e kanaleve:', error);
      if (statusEl) {
        statusEl.innerHTML = `<div class="error-icon">⚠️</div> Gabim në ringarkimin e kanaleve: ${error.message || 'Gabim i panjohur'}`;
      }
    }
  });
}

// Initialize channel list after DOM loaded
document.addEventListener('DOMContentLoaded', () => {
  console.log('[Mini IPTV] DOM loaded, initializing channels...');
  
  // Wait for playlist loader to be ready
  document.addEventListener('playlist-loader-ready', () => {
    console.log('[Mini IPTV] Playlist loader ready, loading channels...');
    updateUIWithChannels(true); // Force fetch on initial load
  });
  
  // Try to load immediately if playlist loader is already available
  if (window.playlistLoader) {
    updateUIWithChannels(true);
  } else {
    console.log('[Mini IPTV] Waiting for playlist-loader...');
    
    // Fallback if playlist-loader isn't ready in 2 seconds
    setTimeout(() => {
      if (!window.playlistLoader) {
        console.warn('[Mini IPTV] Playlist-loader not found, using fallback items');
        updateUIWithChannels();
      }
    }, 2000);
  }
});
</script>
</body>
</html>