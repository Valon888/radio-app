<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini IPTV + Radio</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="stylesheet" href="styles.css">
<script src="items.js"></script>
</head>
<body>
<header>
  <img src="file_0000000061906246a7cec4605005f737.png" alt="App Logo" class="app-logo" />
  <span class="app-title accent-blue">Mini IPTV + Radio</span>
  <input id="search" type="search" placeholder="Kërko kanal…" aria-label="Kërko kanal" />
  <select id="filterType" aria-label="Filtri llojit">
    <option value="">Të gjitha</option>
    <option value="tv">TV</option>
    <option value="radio">Radio</option>
  </select>
</header>
<div class="wrap">
  <aside id="list" aria-label="Lista e kanaleve"></aside>
  <main>
    <div class="meta">
      <span id="title" class="title"></span>
      <span id="epg" class="epg"></span>
    </div>
    <div class="player">
      <img id="chanLogo" class="chan-logo" alt="Logo" />
      <div class="resolution-row">
        <label for="resolutionSel" class="resolution-label">Rezolucioni:</label>
        <select id="resolutionSel" class="resolution-select">
          <option value="1080p">1080p</option>
          <option value="720p">720p</option>
        </select>
      </div>
      <video id="video" controls></video>
      <audio id="audio" controls style="display:none"></audio>
    </div>
    <div id="status" class="muted"></div>
  </main>
</div>
<footer>
  <span>© 2025 Mini IPTV + Radio | <a href="https://radiostargjilan.com/web/" target="_blank" rel="noopener" class="accent-blue">Radio Star Gjilan</a></span>
</footer>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.7/dist/hls.min.js"></script>
<script>
// Përdor window.items nga items.js
console.log('window.items:', window.items);
let items = window.items;
console.log('items:', items);

const listEl   = document.querySelector('#list');
const searchEl = document.querySelector('#search');
const typeSel  = document.querySelector('#filterType');
const videoEl  = document.querySelector('#video');
// const audioEl  = document.querySelector('#audio');
const titleEl  = document.querySelector('#title');
const epgEl    = document.querySelector('#epg');
const statusEl = document.querySelector('#status');

let filtered = [...items];
let currentIndex = -1;
let hls;

/* --------- 2) Listimi + kërkimi/filtër --------- */
function renderList(){
  listEl.innerHTML = '';
  filtered.forEach((c,i)=>{
    // Shto klasën 'islamic' për kanalet islame
    const isIslamic = (c.group && c.group.toLowerCase().includes('islam')) || (c.name && c.name.toLowerCase().includes('quran'));
    const row = document.createElement('div');
    row.className = 'chan' + (isIslamic ? ' islamic' : '') + (i===currentIndex ? ' active' : '');
    row.dataset.index = i;
    row.innerHTML = `
      <div class="chan-info">
        <div class="chan-title">${c.name}</div>
      </div>
    `;
    row.onclick = () => selectIndex(i);
    listEl.appendChild(row);
  });
}

function applyFilters(){
  const q = searchEl.value.trim().toLowerCase();
  const t = typeSel.value; // "", "tv", "radio"
  filtered = items.filter(it=>{
    const matchQ = !q || [it.name,it.group,it.type].filter(Boolean).join(' ').toLowerCase().includes(q);
    const matchT = !t || (it.type||'tv')===t;
    return matchQ && matchT;
  });
  if (filtered.length && !filtered.includes(items[currentIndex])) currentIndex = 0;
  renderList();
}

searchEl.addEventListener('input', applyFilters);
typeSel.addEventListener('change', applyFilters);

/* --------- 3) Luajtësi i unifikuar --------- */
function playMedia(entry){
  // Shfaq logon e kanalit
  const logoEl = document.getElementById('chanLogo');
  if (entry.logo && entry.logo.length > 6) {
    logoEl.src = entry.logo;
    logoEl.style.display = '';
    videoEl.setAttribute('poster', entry.logo);
  } else {
    logoEl.style.display = 'none';
    videoEl.removeAttribute('poster');
  }
  if (entry.logo && entry.logo.length > 6) {
    logoEl.src = entry.logo;
    logoEl.style.display = '';
  } else {
    logoEl.style.display = 'none';
  }

  // Zgjidh automatikisht stream-in me cilësi më të lartë (prefer 1080p)
  let url = entry.url;
  if (entry.type === 'tv') {
    const sameName = window.items.filter(x=>x.name===entry.name && x.type==='tv');
    // Prefero 1080p, pastaj 720p, pastaj të tjerat
    const found1080 = sameName.find(x=>x.quality==='1080p');
    const found720 = sameName.find(x=>x.quality==='720p');
    if (found1080) url = found1080.url;
    else if (found720) url = found720.url;
    else if (sameName.length) url = sameName[0].url;
  }

  if (entry.type === 'external'){
    window.open(entry.url, '_blank');
    statusEl.textContent = 'Radio Pendimi u hap në një faqe të re.';
    return;
  }
  statusEl.textContent = 'Duke ngarkuar…';
  const kind = (entry.type || 'tv').toLowerCase();

  // Shfaq vetëm video player-in për TV
  videoEl.style.display = ((entry.type || 'tv').toLowerCase() === 'tv') ? '' : 'none';
  // Hiq iframe ekzistues nëse ka
  let twitchFrame = document.getElementById('twitchFrame');
  if (twitchFrame) twitchFrame.remove();
  let customFrame = document.getElementById('customFrame');
  if (customFrame) customFrame.remove();

  // ç’aktivizo HLS nëse ishte në përdorim
  if (hls){ try{ hls.destroy(); }catch(e){} hls = null; }

  if (kind === 'iframe'){
    // Shfaq radio si iframe
    const playerDiv = document.querySelector('.player');
    const iframe = document.createElement('iframe');
    iframe.id = 'customFrame';
    iframe.src = entry.url;
    iframe.width = '100%';
    iframe.height = '100';
    iframe.scrolling = 'no';
    iframe.frameBorder = 'no';
    playerDiv.appendChild(iframe);
    statusEl.textContent = 'Radio Pendimi (iframe)';
  } else if (kind === 'radio'){
    var audioEl = document.getElementById('audio');
    audioEl.style.display = '';
    audioEl.src = entry.url;
    audioEl.play().catch(()=>{});
    videoEl.style.display = 'none';
    statusEl.textContent = 'Duke luajtur radio.';
  } else if (entry.url.startsWith('https://www.twitch.tv/')) {
    // Twitch: shfaq iframe
    const playerDiv = document.querySelector('.player');
    const channel = entry.url.split('/').pop();
    const iframe = document.createElement('iframe');
    iframe.id = 'twitchFrame';
    iframe.src = `https://player.twitch.tv/?channel=${channel}&parent=localhost`;
    iframe.width = '100%';
    iframe.height = '500';
    iframe.allowFullscreen = true;
    iframe.frameBorder = '0';
    playerDiv.appendChild(iframe);
    statusEl.textContent = 'Twitch duke luajtur';
  } else {
    // TV (HLS)
    videoEl.style.display = '';
    if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
      videoEl.src = url;
      videoEl.play().catch(()=>{});
    } else if (Hls.isSupported()){
      hls = new Hls({lowLatencyMode:true, backBufferLength:90});
      hls.loadSource(url);
      hls.attachMedia(videoEl);
      hls.on(Hls.Events.MANIFEST_PARSED, ()=>videoEl.play().catch(()=>{}));
      hls.on(Hls.Events.ERROR, (_,data)=>{ statusEl.textContent = 'Gabim stream: '+(data?.details||data?.type||'i panjohur'); });
    } else {
      statusEl.textContent = 'Shfletuesi nuk mbështet HLS.';
    }
    videoEl.onplaying=()=>statusEl.textContent='Duke luajtur';
    videoEl.onpause=()=>statusEl.textContent='Pauzë';
  }
}

function selectIndex(i){
  if (i<0 || i>=filtered.length) return;
  currentIndex = i;
  const ch = filtered[i];
  titleEl.textContent = ch.name;
  epgEl.textContent = ch.group ? `Grupi: ${ch.group}` : '—';
  localStorage.setItem('miniiptv_last_id', ch.id);
  renderList();
  playMedia(ch);
}


// Ngarko nga file
// document.getElementById('loadM3U').onclick = ()=>document.getElementById('m3uInput').click();
// document.getElementById('m3uInput').addEventListener('change', async e=>{
//   const file = e.target.files[0]; if(!file) return;
//   const text = await file.text();
//   importM3U(text);
// });

// // Ngarko nga URL
// document.getElementById('importM3UUrl').onclick = async ()=>{
//   const url = document.getElementById('m3uUrlInput').value.trim();
//   if(!url) return alert('Vendos URL-në e M3U!');
//   try {
//     const res = await fetch(url);
//     if (!res.ok) throw new Error('Gabim në shkarkim');
//     const text = await res.text();
//     importM3U(text);
//   } catch (e) {
//     alert('Gabim në shkarkim ose format: '+e.message);
//   }
// };

function importM3U(text){
  // Lexo EPG nga x-tvg-url në rreshtin e parë
  const firstLine = text.split(/\r?\n/)[0];
  let epgUrls = [];
  const epgMatch = firstLine.match(/x-tvg-url="([^"]+)"/);
  if(epgMatch) epgUrls = epgMatch[1].split(',').map(x=>x.trim());
  window.m3uEpgUrls = epgUrls;
  // Importo kanalet
  const tvs = parseM3U(text);
  if (tvs.length){
    items = [...tvs, ...items.filter(x=>x.type==='radio')];
    applyFilters();
    selectIndex(0);
    if(epgUrls.length) statusEl.textContent = 'EPG gjetur: '+epgUrls.length+' burime';
  } else alert('S’u gjetën kanale TV në M3U.');
}

function parseM3U(txt){
  const lines = txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out = []; let meta=null;
  for (let i=0;i<lines.length;i++){
    const l = lines[i];
    if (l.startsWith('#EXTINF')){
      const nameMatch = l.match(/,(.*)$/);
      const tvgName   = (l.match(/tvg-name="([^"]+)"/) || [])[1];
      const group     = (l.match(/group-title="([^"]+)"/) || [])[1];
      const logo      = (l.match(/tvg-logo="([^"]+)"/) || [])[1];
      meta = { name:(tvgName || (nameMatch?nameMatch[1]:'TV')), group:group||'', logo:logo||'' };
    } else if (!l.startsWith('#') && meta){
      out.push({ id:`tv-${out.length}-${Date.now()}`, name:meta.name.trim(), url:l, type:'tv', group:meta.group, logo:meta.logo });
      meta=null;
    }
  }
  return out;
}

/* --------- 5) Shkurtore dhe init --------- */
document.addEventListener('keydown', e=>{
  if (['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;
  if (e.key===' '){ e.preventDefault();
    const kind = filtered[currentIndex]?.type || 'tv';
  if (videoEl.paused) videoEl.play(); else videoEl.pause();
  }
  if (e.key==='ArrowDown'){ e.preventDefault(); selectIndex(Math.min(currentIndex+1, filtered.length-1)); }
  if (e.key==='ArrowUp'){ e.preventDefault(); selectIndex(Math.max(currentIndex-1, 0)); }
});


// URL M3U për import automatik
const AUTO_M3U_URL = "http://192.168.1.2:5501/al.m3u"; // ndryshoje sipas nevojës

async function autoImportM3U(){
  try {
    const res = await fetch(AUTO_M3U_URL);
    if (!res.ok) throw new Error('Gabim në shkarkim');
    const text = await res.text();
    // Lexo EPG nga x-tvg-url në rreshtin e parë
    const firstLine = text.split(/\r?\n/)[0];
    let epgUrls = [];
    const epgMatch = firstLine.match(/x-tvg-url="([^"]+)"/);
    if(epgMatch) epgUrls = epgMatch[1].split(',').map(x=>x.trim());
    window.m3uEpgUrls = epgUrls;
    importM3U(text);
    if(epgUrls.length) statusEl.textContent = 'EPG gjetur: '+epgUrls.length+' burime';
  } catch (e) {
    statusEl.textContent = 'Gabim në import automatik: '+e.message;
    applyFilters();
    const lastId = localStorage.getItem('miniiptv_last_id');
    if (lastId){
      const j = items.findIndex(x=>x.id===lastId);
      if (j>=0){ filtered=[...items]; renderList(); selectIndex(j); return; }
    }
    if (filtered.length) selectIndex(0);
  }
}


// Inicializo listën e kanaleve nga items.js kur faqja hapet
window.addEventListener('DOMContentLoaded', () => {
  applyFilters();
  if (filtered.length) selectIndex(0);
  // Event për ndërrimin e rezolucionit
  const resSel = document.getElementById('resolutionSel');
  if (resSel) {
    resSel.addEventListener('change', ()=>{
      if (filtered.length && currentIndex>=0) playMedia(filtered[currentIndex]);
    });
  }
});
</script>
</body>
</html>
